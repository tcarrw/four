<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>four ¬∑ Opalite Edition ‚Äî Lyric/Visual + Self-Check</title>
<meta name="description" content="Opalite glass, parallax opal sky, AirPlay-ready. Lyric/Visual toggle, multi timed notes, Cast Mode, and built-in self-check.">
<style>
  :root{
    --bg:#081014; --ink:#eef5f8; --ink-d:#b6c6cf;
    --opal1:#cfe9ff; --opal2:#ffd6ec; --opal3:#d7ffe7; --opal4:#f7f1ff;
    --edge:rgba(255,255,255,.10); --ring:rgba(180,230,255,.55);
    --glass:rgba(255,255,255,.18); --glass-deep:rgba(255,255,255,.12);
    --ok:#8ef0c2; --warn:#ffd38a; --bad:#ff9aa2;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;color:var(--ink);background:var(--bg);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
    -webkit-font-smoothing:antialiased}
  .sky{position:fixed;inset:0;z-index:-2;overflow:hidden;pointer-events:none}
  .opal{position:absolute;inset:-10%;
    background:
      radial-gradient(1200px 700px at 70% -10%, rgba(207,233,255,.18), transparent 60%),
      radial-gradient(900px 600px at 0% 100%, rgba(255,214,236,.16), transparent 60%),
      radial-gradient(800px 520px at 120% 40%, rgba(215,255,231,.14), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0) 65%),
      var(--bg);
    filter:saturate(1.08) blur(.2px);transition:opacity .35s ease, transform .2s ease}
  .shimmer{position:absolute;inset:-20%;background:conic-gradient(from 0deg,
      rgba(255,255,255,.0) 0%,rgba(255,255,255,.12) 6%,rgba(255,255,255,.0) 12%,
      rgba(255,255,255,.1) 18%,rgba(255,255,255,.0) 24%,rgba(255,255,255,.08) 30%,
      rgba(255,255,255,.0) 36%,rgba(255,255,255,.10) 42%,rgba(255,255,255,.0) 48%,
      rgba(255,255,255,.08) 54%,rgba(255,255,255,.0) 60%,rgba(255,255,255,.10) 66%,
      rgba(255,255,255,.0) 100%);
    mix-blend-mode:screen;opacity:.28;animation:spin 28s linear infinite;filter:blur(18px)}
  @keyframes spin{to{transform:rotate(360deg)}}
  .pearls{position:absolute;inset:0;opacity:.5;mix-blend-mode:screen;background:
      radial-gradient(2px 2px at 15% 30%, #fff, transparent 35%),
      radial-gradient(1.5px 1.5px at 42% 70%, #fff, transparent 35%),
      radial-gradient(1.4px 1.4px at 75% 22%, #fff, transparent 35%),
      radial-gradient(1.8px 1.8px at 90% 64%, #fff, transparent 35%),
      radial-gradient(1.2px 1.2px at 58% 46%, #fff, transparent 35%),
      transparent}
  .wrap{max-width:980px;margin:min(4vh,40px) auto;padding:16px}
  header{display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-bottom:14px}
  .gem{font-size:22px}
  h1{margin:0;font-size:clamp(20px,3.6vw,28px)}
  .lede{margin:6px 0 10px;color:var(--ink-d)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  .panel{position:relative;overflow:hidden;border-radius:18px;
    background:linear-gradient(180deg,var(--glass),var(--glass-deep)),
              linear-gradient(120deg, rgba(207,233,255,.22), rgba(255,214,236,.16), rgba(215,255,231,.18), rgba(247,241,255,.14));
    border:1px solid var(--edge);
    box-shadow:0 24px 60px rgba(0,0,0,.45),0 0 0 1px rgba(255,255,255,.06) inset,0 1px 0 rgba(255,255,255,.35) inset;
    backdrop-filter:blur(16px) saturate(1.1);-webkit-backdrop-filter:blur(16px) saturate(1.1);padding:12px}
  .yt{width:100%;aspect-ratio:16/9;border-radius:14px;overflow:hidden;background:#000}
  .controls{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;padding:8px 6px 10px}
  .buttons{display:flex;align-items:center;gap:10px}
  button,.toggle{appearance:none;border:0;background:transparent;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
  button:hover,.toggle:hover{background:rgba(255,255,255,.08)}
  .bigplay{display:flex;align-items:center;gap:10px;padding:12px 16px;border:1px solid rgba(255,255,255,.18);border-radius:12px;background:rgba(255,255,255,.10)}
  .state{color:var(--ink-d);font-size:14px}

  .mode{display:flex;align-items:center;gap:6px}
  .seg{display:inline-flex;border:1px solid rgba(255,255,255,.18);border-radius:12px;overflow:hidden}
  .seg button{padding:8px 12px}
  .seg button.active{background:rgba(255,255,255,.12)}
  .checkpill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18)}
  .checkpill.ok{color:#032; background:linear-gradient(180deg, rgba(142,240,194,.35), rgba(142,240,194,.15))}
  .checkpill.warn{color:#402e00; background:linear-gradient(180deg, rgba(255,211,138,.35), rgba(255,211,138,.12))}
  .checkdetail{display:none;margin-top:8px;color:var(--ink-d);font-size:12px}
  .checkpill[data-open="1"] + .checkdetail{display:block}

  .queue{display:grid;gap:10px;margin-top:10px}
  .track{display:grid;grid-template-columns:56px 1fr;gap:10px;align-items:center;padding:10px;border-radius:12px;background:rgba(255,255,255,.08);border:1px solid var(--edge)}
  .badge{width:56px;height:56px;border-radius:12px;background:
      radial-gradient(120% 120% at 20% 10%, var(--opal1), transparent 60%),
      radial-gradient(120% 120% at 80% 90%, var(--opal2), transparent 60%),
      radial-gradient(140% 140% at -10% 80%, var(--opal3), transparent 60%), #e8f4ff;
    box-shadow:0 0 0 2px rgba(0,0,0,.35) inset,0 10px 18px rgba(0,0,0,.25);
    display:flex;align-items:center;justify-content:center;font-weight:800;color:#0a0f12}
  .meta{display:flex;flex-direction:column;gap:2px}
  .title{font-weight:700}
  .note{color:var(--ink-d);font-size:14px}
  .track.active{outline:2px solid var(--ring);background:rgba(255,255,255,.12)}

  .note-fly{position:absolute;top:12%;left:110%;padding:8px 12px;border-radius:14px;
    background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.30);color:var(--ink);
    font-size:14px;white-space:nowrap;backdrop-filter:blur(10px) saturate(1.15);-webkit-backdrop-filter:blur(10px) saturate(1.15);
    box-shadow:0 6px 20px rgba(0,0,0,.25),0 1px 0 rgba(255,255,255,.35) inset;animation:glide 10s linear forwards}
  .note-fly.whisper{opacity:.85}
  .note-fly.ping{box-shadow:0 0 0 2px rgba(255,255,255,.4) inset,0 10px 26px rgba(0,0,0,.3)}
  @keyframes glide{0%{transform:translate(0,-6px);opacity:0}10%{opacity:1}55%{transform:translate(-60vw,0)}100%{transform:translate(-125vw,-14px);opacity:0}}

  footer{margin:18px 0 10px;color:var(--ink-d);font-size:12px}
  .footer-box{margin-top:10px;padding:12px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.12);box-shadow:0 8px 24px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.05) inset;backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px)}
  .opal-ink{background: linear-gradient(120deg, var(--opal1), var(--opal2), var(--opal3), var(--opal4));-webkit-background-clip: text;background-clip: text;color: transparent;font-style: italic}
  .smallcaps{font-variant: small-caps; letter-spacing:.02em}

  .cast header,.cast footer{display:none}
  .cast .wrap{max-width:1200px;padding:8px;margin:0 auto}
  .cast .panel{margin-top:8vh}
  .cast .yt{aspect-ratio:21/9}
  .cast .opal{opacity:1}
</style>
</head>
<body>
  <div class="sky" aria-hidden="true">
    <div class="opal" id="opal"></div>
    <div class="shimmer"></div>
    <div class="pearls"></div>
  </div>

  <div class="wrap">
    <header>
      <div class="gem">ü™Ω</div>
      <div>
        <h1>four ¬∑ Opalite Edition</h1>
        <p class="lede">Opalite glass UI, parallax opal sky, native AirPlay via the video controls. Toggle <em>Cast Mode</em> for TV.</p>
      </div>
    </header>

    <section class="panel" aria-label="player">
      <div id="yt" class="yt" role="region" aria-label="YouTube player" allow="autoplay; encrypted-media; picture-in-picture"></div>

      <div class="controls">
        <div class="buttons">
          <button id="prev" aria-label="Previous">‚èÆ</button>
          <button id="play" class="bigplay" aria-label="Play/Pause">‚ñ∂Ô∏é Play</button>
          <button id="next" aria-label="Next">‚è≠</button>
        </div>

        <div class="row">
          <div class="mode" aria-label="video mode">
            üé¨ Mode:
            <div class="seg" role="tablist" aria-label="Lyric or Visual">
              <button id="btnLyric" role="tab" aria-selected="true" class="active">Lyric</button>
              <button id="btnVisual" role="tab" aria-selected="false">Visual</button>
            </div>
          </div>

          <button class="toggle" id="loopToggle" role="switch" aria-checked="true">üîÅ Loop: <strong>On</strong></button>
          <button class="toggle" id="castToggle" title="Expand visuals for AirPlay/screen casting">üñ•Ô∏è Cast Mode: <strong>Off</strong></button>

          <span class="state" id="state">Ready</span>
          <button id="checkpill" class="checkpill" title="Self-Check">Self-check: running‚Ä¶</button>
        </div>

        <div id="checkdetail" class="checkdetail"></div>
      </div>

      <div class="queue" id="queue" aria-label="queue"></div>
    </section>

    <footer>
      Official videos from Taylor‚Äôs channel where available. Tap a track to jump. Loop replays the same track; turn off to advance.

      <div class="footer-box" aria-label="curiosity prompt and six-song arc">
        <div class="opal-ink">‚ú® curiosity prompt:</div>
        <div style="margin:6px 0 10px">
          ask grok ‚Äî ‚Äúdoes the six-song arc lean more toward taylor nation or toward the muse she wrote it for? and if it‚Äôs neither, what‚Äôs the metaphor behind the forest imagery?‚Äù
        </div>

        <div class="smallcaps" style="color:var(--ink)">üí† the six-song arc</div>
        <ol style="margin:8px 0 0 18px; padding:0">
          <li><strong>Lavender Haze</strong> ‚Äî entering the dream before reason.</li>
          <li><strong>Maroon</strong> ‚Äî when passion stains what used to be soft.</li>
          <li><strong>Anti-Hero</strong> ‚Äî watching your reflection learn to breathe.</li>
          <li><strong>Midnight Rain</strong> ‚Äî splitting light from sound to hear yourself again.</li>
          <li><strong>You‚Äôre On Your Own, Kid</strong> ‚Äî the solitude that teaches you melody.</li>
          <li><strong>Mastermind</strong> ‚Äî turning pattern into choice, and choice into peace.</li>
        </ol>
      </div>
    </footer>
  </div>

<script>
/* Track data (same titles/notes; mode swaps the video IDs) */
const Notes = [
  [
    {t:10,text:"red ‚Üí gold",type:"whisper"},
    {t:28,text:"light evolves"},
    {t:64,text:"wavelength shift",type:"ping"},
    {t:95,text:"edges soften"},
    {t:125,text:"origin becomes glow"}
  ],
  [
    {t:7,text:"two timelines",type:"whisper"},
    {t:12,text:"sunshine ‚Üî midnight"},
    {t:33,text:"weather in the vocal",type:"ping"},
    {t:48,text:"split, then rejoin"},
    {t:102,text:"voices trade places"}
  ],
  [
    {t:14,text:"child ‚Üî adult"},
    {t:27,text:"memory doesn‚Äôt age",type:"whisper"},
    {t:54,text:"seven = circle"},
    {t:81,text:"time feels like color"},
    {t:96,text:"home as a frequency",type:"ping"}
  ],
  [
    {t:12,text:"saved like a spell"},
    {t:22,text:"glitter countdown",type:"ping"},
    {t:48,text:"we keep what we sing"},
    {t:72,text:"time preserved"},
    {t:130,text:"circle closes",type:"whisper"}
  ]
];

/* Lyric IDs (official) */
const IDs_Lyric = ["u9raS7-NisU","Odh9ddPUkEY","pEY-GPsru_E","F5TMU6916U8"];
/* Visual IDs (official music/visual where available; fallback to lyric if needed) */
const IDs_Visual = [
  "mweYZKxvWUQ",   /* Daylight ‚Äî short film (official) */
  "Odh9ddPUkEY",   /* Midnight Rain ‚Äî no MV; using lyric */
  "pEY-GPsru_E",   /* seven ‚Äî no MV; using lyric */
  "F5TMU6916U8"    /* Long Live (TV) ‚Äî lyric */
];

/* Titles & hints (shared) */
const Titles = [
  "Daylight ‚Äî Lover",
  "Midnight Rain ‚Äî Midnights",
  "seven ‚Äî folklore",
  "Long Live (Taylor‚Äôs Version) ‚Äî Speak Now (TV)"
];
const Hints = [
  "red ‚Üí gold; light as evolution",
  "sunshine / midnight; voices swap",
  "memory loop; child ‚Üî adult",
  "countdown in glitter; preserved time"
];

let mode = localStorage.getItem("four.mode") || "lyric";  // "lyric" | "visual"
let player, current=0, looping=true, castMode=false, tick=null, lastNoteIndex=-1;

/* Parallax */
(function(){
  const opal=document.getElementById('opal');
  const move=(x,y)=>{ opal.style.transform=`translate3d(${x}px, ${y}px, 0)`; };
  addEventListener('mousemove', e=>{
    const dx=(e.clientX/innerWidth-.5)*-18, dy=(e.clientY/innerHeight-.5)*-10; move(dx,dy);
  }, {passive:true});
  addEventListener('deviceorientation', e=>{
    if(e && e.beta!=null){ move((e.gamma||0)*.55, (e.beta||0)*.28); }
  }, {passive:true});
})();

/* Helpers */
const ID_OK = s => typeof s==="string" && /^[\w-]{11}$/.test(s);
const getIDs = () => (mode==="visual"? IDs_Visual: IDs_Lyric);

/* UI */
function renderModeButtons(){
  const bL=document.getElementById('btnLyric');
  const bV=document.getElementById('btnVisual');
  if(mode==="lyric"){ bL.classList.add('active'); bL.setAttribute('aria-selected','true'); bV.classList.remove('active'); bV.setAttribute('aria-selected','false'); }
  else{ bV.classList.add('active'); bV.setAttribute('aria-selected','true'); bL.classList.remove('active'); bL.setAttribute('aria-selected','false'); }
}
function renderQueue(){
  const q=document.getElementById('queue'); q.innerHTML="";
  const ids=getIDs();
  Titles.forEach((title,i)=>{
    const b=document.createElement('button');
    b.className='track'+(i===current?' active':'');
    b.setAttribute('aria-label', title+'. '+Hints[i]);
    b.onclick=()=>load(i,true);
    b.innerHTML=`<div class="badge">${i+1}</div>
      <div class="meta"><div class="title">${title}</div><div class="note">${Hints[i]} <span style="opacity:.7">(${mode})</span></div></div>`;
    q.appendChild(b);
  });
}
function status(s){ document.getElementById('state').textContent=s; }

function fly(text, type){
  const host=document.querySelector('.panel');
  const el=document.createElement('div');
  el.className='note-fly'+(type?(' '+type):'');
  el.textContent=text;
  const lanes=7; const lane=Math.floor(Math.random()*lanes);
  const top=12 + lane*((74-12)/lanes);
  el.style.top= top + '%';
  host.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 10500);
}

/* Player */
function load(i, playAfter){
  current=(i+Titles.length)%Titles.length; lastNoteIndex=-1; renderQueue();
  const v=getIDs()[current];
  if(playAfter){ player.loadPlaylist({listType:'playlist',playlist:[v],index:0,startSeconds:0}); }
  else{ player.cuePlaylist({listType:'playlist',playlist:[v],index:0,startSeconds:0}); }
  status("Loaded: "+Titles[current]+" ‚Ä¢ "+mode);
}
function next(){ load(current+1,true) }
function prev(){ load(current-1,true) }

function startTicker(){
  stopTicker();
  tick=setInterval(()=>{
    if(!player || typeof player.getCurrentTime!=='function') return;
    if(player.getPlayerState()!==1) return;
    const t=player.getCurrentTime?player.getCurrentTime():0;
    const notes=Notes[current]||[];
    for(let i=lastNoteIndex+1;i<notes.length;i++){
      if(t>=notes[i].t){ fly(notes[i].text, notes[i].type); lastNoteIndex=i; }
      else break;
    }
  }, 250);
}
function stopTicker(){ if(tick){ clearInterval(tick); tick=null; } }

function onYouTubeIframeAPIReady(){
  player=new YT.Player('yt',{
    width:'100%',height:'100%',videoId:getIDs()[0],
    playerVars:{autoplay:0,controls:1,rel:0,playsinline:1,modestbranding:1,iv_load_policy:3},
    events:{
      onReady:()=>{ renderModeButtons(); renderQueue(); status("Tap ‚ñ∂Ô∏é to begin ("+mode+")"); selfCheck(); },
      onStateChange:(e)=>{
        if(e.data===1){ status("Playing: "+Titles[current]); startTicker(); }
        if(e.data===2){ status("Paused"); }
        if(e.data===0){
          if(looping){ player.loadPlaylist({listType:'playlist',playlist:[getIDs()[current]],index:0,startSeconds:0}); lastNoteIndex=-1; }
          else{ next(); }
        }
      }
    }
  });
}
window.onYouTubeIframeAPIReady=onYouTubeIframeAPIReady;

/* Controls */
document.getElementById('play').addEventListener('click', ()=>{
  const s=player.getPlayerState(); s===1?player.pauseVideo():player.playVideo();
});
document.getElementById('next').addEventListener('click', next);
document.getElementById('prev').addEventListener('click', prev);
document.getElementById('loopToggle').addEventListener('click', function(){
  looping=!looping; this.innerHTML='üîÅ Loop: <strong>'+(looping?'On':'Off')+'</strong>';
});

document.getElementById('castToggle').addEventListener('click', function(){
  castMode=!castMode; document.body.classList.toggle('cast', castMode);
  this.innerHTML='üñ•Ô∏è Cast Mode: <strong>'+(castMode?'On':'Off')+'</strong>';
});
['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'].forEach(ev=>{
  document.addEventListener(ev, ()=>{
    const fs=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;
    const want=!!fs;
    if(want!==castMode){
      castMode=want; document.body.classList.toggle('cast', castMode);
      document.getElementById('castToggle').innerHTML='üñ•Ô∏è Cast Mode: <strong>'+(castMode?'On':'Off')+'</strong>';
    }
  });
});

/* Mode toggle */
document.getElementById('btnLyric').addEventListener('click', ()=>{
  if(mode!=="lyric"){ mode="lyric"; localStorage.setItem("four.mode",mode); renderModeButtons(); selfCheck(); load(current,false); }
});
document.getElementById('btnVisual').addEventListener('click', ()=>{
  if(mode!=="visual"){ mode="visual"; localStorage.setItem("four.mode",mode); renderModeButtons(); selfCheck(); load(current,false); }
});

/* Self-Check (UI only, no console) */
function selfCheck(){
  const pill=document.getElementById('checkpill');
  const det=document.getElementById('checkdetail');
  const ids=getIDs();
  const out=[];
  let ok=true;

  const apiLoaded = !!window.YT && !!window.YT.Player;
  out.push((apiLoaded?"‚úÖ":"‚ö†Ô∏è")+" YouTube API "+(apiLoaded?"loaded":"not yet"));

  const playerReady = !!player;
  out.push((playerReady?"‚úÖ":"‚ö†Ô∏è")+" Player "+(playerReady?"ready":"not ready"));

  const idsValid = ids.length===4 && ids.every(ID_OK);
  out.push((idsValid?"‚úÖ":"‚ö†Ô∏è")+" Video IDs: "+(idsValid?"ok":"check one or more IDs"));

  const arraysAligned = Titles.length===Hints.length && Hints.length===Notes.length && Notes.length===4;
  out.push((arraysAligned?"‚úÖ":"‚ö†Ô∏è")+" Data aligned");

  ok = apiLoaded && playerReady && idsValid && arraysAligned;

  pill.className = "checkpill " + (ok ? "ok" : "warn");
  pill.textContent = "Self-check: " + (ok ? "OK" : "Issues");
  det.textContent = out.join(" ¬∑ ");
}
document.getElementById('checkpill').addEventListener('click', function(){
  const open=this.getAttribute('data-open')==="1";
  this.setAttribute('data-open', open? "0":"1");
  selfCheck();
});

/* Load YouTube API */
(function(){
  const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api";
  const first=document.getElementsByTagName('script')[0]; first.parentNode.insertBefore(tag, first);
})();
</script>
</body>
</html>
